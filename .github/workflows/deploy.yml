name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: patelharsh4304
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
        # run: |
        #   docker login -u patelharsh4304 -p ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v3
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{patelharsh4304}}/{testdocker_ci_cd_pipeline}:${{ github.sha }}
            ${{patelharsh4304}}/{testdocker_ci_cd_pipeline}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
            ghcr.io/${{ github.repository }}:latest
        # run: |
        #   docker build -t patelharsh4304/testdocker_ci_cd_pipeline:funning-nextjs-app .
        #   docker push patelharsh4304/testdocker_ci_cd_pipeline:funning-nextjs-app

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to server
        run: |
          ssh user@your-server "
            # Stop and remove old container if it exists
            docker ps -q --filter 'ancestor=funning-nextjs-app' | xargs -r docker stop | xargs -r docker rm;
            
            # Remove old image locally to free space
            docker images 'funning-nextjs-app' -q | xargs -r docker rmi;
            
            # Pull new image and run new container
            docker pull funning-nextjs-app:$GITHUB_SHA;
            docker run -d --name funning-nextjs-app-container funning-nextjs-app:$GITHUB_SHA
          "
          
      - name: Remove old image from Docker Hub (optional)
        run: |
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
          # List all images and delete old ones from Docker Hub
          # Here you should customize logic to identify old images based on your tagging scheme
          # Example: Deleting images older than the current image
          docker image ls --filter 'dangling=true' -q | xargs -r docker rmi
